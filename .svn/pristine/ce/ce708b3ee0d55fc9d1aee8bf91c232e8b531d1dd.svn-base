<?php 

App::uses('Controller', 'Controller');

/**
 * Followers Controller
 *
 * Purpose : Manage follows
 * @project Crossfit
 * @since 1 July 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class FollowersController extends AppController 
{
	public $name = 'Followers';
	public $components = array('RequestHandler');
	public $uses = array('Follower', 'User');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();
		
	}
	
	
	/**
	 * Method Name : follow
	 * Author Name : Vivek Sharma
	 * Date : 1 July 2014
	 * Description : Follow user
	 */
	 public function follow()
	 {
	 	$following_id = $this->data['following_id'];
		$user_id = $this->data['user_id'];
		
		$exist = $this->Follower->find('first', array('conditions' => array('Follower.user_id' => $user_id, 'Follower.following_id' => $following_id)));
		
		if ( empty($exist) )
		{
			$this->Follower->create();
			$this->Follower->save(array('user_id' => $user_id, 'following_id' => $following_id, 'created' => date('Y-m-d H:i:s')));
			
			$user = $this->User->find('first', array('conditions' => array('User.id' => $user_id),
													'fields' => array('User.first_name', 'User.last_name', 'User.email')));
													
			
			$arr = array('from_id' => $user_id, 'to_id' => $following_id, 'from_first_name' => $user['User']['first_name'], 
							'from_last_name' => $user['User']['last_name'], 'from_email' => $user['User']['email'],'subject' => 'New Fan!', 'message' => 'New Fan!',
								'type' => '2','created' => date('Y-m-d H:i:s'));
			
			$this->loadModel('Message');
			$this->Message->create();
			$this->Message->save($arr);
		}
		echo 'success'; die;	 	
	 }
	 
	 /**
	 * Method Name : unfollow
	 * Author Name : Vivek Sharma
	 * Date : 1 July 2014
	 * Description : Unfollow user
	 */
	 public function unfollow()
	 {
	 	$following_id = $this->data['following_id'];
		$user_id = $this->data['user_id'];
		
		$exist = $this->Follower->find('first', array('conditions' => array('Follower.user_id' => $user_id, 'Follower.following_id' => $following_id)));
		
		if ( !empty($exist) )
		{
			$this->loadModel('Message');
			$this->Message->deleteAll(array('Message.type' => '2', 'Message.from_id' => $exist['Follower']['user_id'], 'Message.to_id' => $exist['Follower']['following_id']));
			$this->Follower->delete($exist['Follower']['id']);
		}
		echo 'success'; die;	 	
	 }
	 
}
	 