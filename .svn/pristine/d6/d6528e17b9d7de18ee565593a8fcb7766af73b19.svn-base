<?php
 echo $this->Html->script('jquery-ui.custom'); 
 echo $this->Html->css(array('jquery-ui.custom')); 
 ?>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>

<style>
#map-canvas label.error{  display: block; margin-left: 225px; margin-top: 6px; position: absolute;}

.column-body.graybg.create-event input[type="text"], 
.column-body.graybg.create-event textarea, 
.column-body.graybg.create-event select, 
.column-body.graybg.create-event input[type="file"] {
	margin-bottom: 0;
}
</style> 


	<!-- MId Section -->
	<section class="body-content-bg ptb25 row">
		<div class="page-mid">
			<div class="body-content-mn row mt10">
				<div class="row">
					<div class="register-columns">
						<?php echo $this->Form->create('Event',array('type'=>'file','id'=>'CreateEventForm','class'=>'border-btm')); ?>
						<div class="column">
							
							<div class="header">
								<h3>Edit EVENT </h3>
								<div class="blue save-btn">								
                                  <?php echo $this->Form->submit('Save',array('id'=>'save_event')); ?>  
								</div>								  
								
							</div>
							<?php 
								echo $this->Session->flash('success');
								echo $this->Session->flash('error');
								echo $this->Session->flash();
							?>
							<div class="column-body graybg create-event">							

								<div class="form-container no-lmr">							
									
									<?php echo $this->Form->input('counter_pricing',array('type'=>'hidden','value'=>count($event['Eventprice']) + 1)); ?>
                                    <div class="left-side-box">
										<ul class="two-columns">
											<li>
												<?php echo $this->Form->label('Event.title','Event Title'); 
													echo $this->Form->input('Event.title',array('type'=>'text','class'=>'required','label'=>false,'div'=>false)); 
												?>											
											</li>
											<li>
												<?php echo $this->Form->label('Event.picture','Event Picture'); ?>												
													<div class="inputbrows">
                                                        <div class='fancy-file' style="overflow:inherit !important;">
                                                            <div class='fancy-file-name'>&nbsp;</div>
                                                            <button class='fancy-file-button'>Browse...</button>
                                                            <div class='input-container'>
                                                                <?php echo $this->Form->input('Event.picture',array('type'=>'file','class'=>'required','label'=>false,'div'=>false,'onchange'=>'readURL(this)')); ?>
                                                            </div>
                                                        </div>
                                                    </div>
                                                     <div class="inputtype">
														<img id="img_prev" src="<?php echo $this->webroot.'files/events/'.$event['Event']['id'].'/thumb_'.$event['Event']['picture']; ?>" alt="" height="70" width="70" style="height:70px;" />
													
													</div>
											</li>
										</ul>
										<ul class="two-columns clear-after">
											<li class="full">
											<?php echo $this->Form->label('Event.details','Event Details'); 
													echo $this->Form->input('Event.details',array('type'=>'textarea','class'=>'text-area','div'=>false,'label'=>false));	
												?>												
											</li>
										</ul>
										
										<?php $i=1;
										  foreach($event['Eventprice'] as $price) { ?>
										<ul class="two-columns pricing price_box_<?php echo $i; ?> clear-after">
											<li>
												<?php echo $this->Form->label('Eventprice.'.$i.'.price','Pricing'); 
													echo $this->Form->input('Eventprice.'.$i.'.price',array('type'=>'text','class'=>'required number','value' => $price['price'],'div'=>false,'label'=>false));	
												?>												
											</li>
											<li class="with-calendar">
												<?php echo $this->Form->label('Eventprice.'.$i.'.date','Date'); 
													echo $this->Form->input('Eventprice.'.$i.'.date',array('type'=>'text','value' => $price['date'] ,'class'=>'required datepick','div'=>false, 'readonly' => 'readonly','label'=>false));	
												?>	
											</li>			
											
										</ul>
										<?php $i++; } ?>
										<ul class="two-columns no-tmr" style="padding-top:7px; padding-bottom:17px;">
										<li><a href="javascript://" onclick="add_pricing_div();">Add more pricing</a></li>
										</ul>
										<ul class="two-columns">
											<li class="full">
												<?php echo $this->Form->label('Event.notes','Notes'); 
													echo $this->Form->input('Event.notes',array('type'=>'textarea','class'=>'text-area','div'=>false,'label'=>false));	
												?>
											</li>
										</ul>
										
                                        </div> <!--left side box ends -->
                                        
                                        <!--right side map box-->
                                        <input type="hidden" name="data[Event][latitude]" id="latitude"/>
                                        <input type="hidden" name="data[Event][longitude]" id="longitude"/>
                                        <input type="text" placeholder="Type Location" id="location" name="data[Event][location]"  class="location required" />
                                        <div class="right-side-box map" id="map-canvas">
                                        	
                                        </div>
                                        <div class="clear"></div>
                                        <!--right side map box ends-->
                                       
                                      
                                        <section class="section-form-section">
                                        <div class="clearfix"></div>
                                        <div style="margin-top:25px;">
										<ul style="vertical-align:top;">
											<li>
												<?php echo $this->Form->label('Event.event_type','Event Type'); 
													echo $this->Form->input('Event.event_type',array('type'=>'select','options'=>array('competition'=>'Competition','throwdown'=>'Throwdown','challenge'=>'Challenge','fundraiser'=>'Fundraiser'),'class'=>'required','div'=>false, 'onchange' => 'check_event_type(this.value)', 'label'=>false));	
												?>												
											</li>
											<li>
												<?php echo $this->Form->label('Event.mode','Public/Private'); 
													echo $this->Form->input('Event.mode',array('type'=>'select','options'=>array('public'=>'Public','private'=>'Private'),'class'=>'required','div'=>false,'label'=>false));	
												?>												
											</li>
										</ul>
										<ul class="middle" id="duration_div" style="vertical-align:top; margin-top:0px;">
											<li>
												<?php 
													$days_options = array();
													for( $j=1; $j<31; $j++ )
													{
														$days_options[$j]=$j;
													}
													echo $this->Form->label('Event.duration','Duration'); 
													echo $this->Form->input('Event.duration_type',array('type'=>'select','options'=>array('days'=>'Days','weeks'=>'Weeks','months'=>'Months'),'class'=>'required','div'=>false,'label'=>false));	
													echo $this->Form->input('Event.duration',array('type'=>'select','options'=>$days_options,'div'=>false,'class'=>'required','label'=>false,'class'=>'too-small'));	
												?>											
											</li>
										</ul>
										<ul class="date-time" style="vertical-align:top; margin-top:0px;">
											<li>
												<?php echo $this->Form->label('Event.start_date','Date'); 
													  echo $this->Form->input('Event.start_date',array('type'=>'text','class'=>'required datepick', 'readonly' => 'readonly','label'=>false,'div'=>false)); 
												?>
											</li>
											<li>
												<?php echo $this->Form->label('Event.start_time','Time'); 
													  echo $this->Form->input('Event.start_time',array('type'=>'time','class'=>'required','label'=>false,'div'=>false)); 
												?>
											</li>
										</ul>
										</div>
                                        <input type="button" class="gray-btn mb20" onclick="invite_athlete_popup();" value="Invite atheletes/affiliates /teams etc " style="margin-top:30px;"/>
                                        <div class="clear"></div>
                                        
                                        <input type = "hidden" id = "number_invited_people" value = "0" />
                                        <div class="invited_people_div"></div>	 
                                        
                                        <ul class="display_people">							
										</ul>                                                                  
                                     
                                        <div class="clear"></div>                                  
										
										</section>                            
                                    
								</div>
								<div class="clear"></div>
							</div>
							
						</div><!--.left-column-->

						<div class="column">
							<div class="column-body graybg create-event">
								<div class="form-container no-lmr">
									<section class="section-form-section division_section">
										
                                        <div class="clearfix"></div>
                                        <input type="hidden" id="division_count" value="<?php echo count($event['EventWod']); ?>"/>
										<ul>
											<li>
												<label>Divisions	</label>
                                                <select class="medium" id="division"> 
                                                    <option value='Male open'> Male open</option>
                                                    <option value='Female open'> Female open</option>
                                                    <option value='Male masters'> Male masters</option>
                                                    <option value='Female masters'> Female masters</option>
                                                </select>
											</li>
											<li>
												<label>  Sex	</label>
                                                <select class="medium" id='division_sex'> 
                                                    <option value='Male'> Male </option>
                                                    <option value='Female'> Female</option>
                                                    
                                                </select>
											</li>
										</ul>
										<ul class="middle">
											<li>
												<label> Number of Wods	</label>
                                                <select class="small" id='number_of_wods'> 
                                                    <?php for( $k=1; $k < 11; $k++){ ?>
														<option value='<?php echo $k; ?>'><?php echo $k; ?></option>
                                                    <?php } ?>
                                                </select>
											</li>
										</ul>
										<ul class="middle right-list">
                                        	<li>
                                            	
                                        <input type="button" class="gray-btn mt25" value="Add New Division" onclick="add_division();"/>
                                            </li>
                                        </ul>
									
									</section>
								
									<?php 
										$i=1;
										if ( !empty($event['EventWod']) ) {
											
											foreach($event['EventWod'] as $wd){ 
									 ?>
									 
									
										<section class="bottom-section new_division_<?php echo $i; ?>">
						<div class="accdion">
							<div class="accordion open" onclick="toggle_wod(<?php echo $i; ?>);"><h3><?php echo ucwords($wd['division_type']); ?> / RX <?php echo ucwords($wd['division_sex']); ?>   /  <?php echo $i; ?> </h3></div>
						</div>
						
						<div class="section-form-section wod_form_<?php echo $i; ?>" >
						<div class="clearfix"></div>
						<ul>
							<li>
								<label>Weight Class </label>
								<select class="medium" name="data[Wod][<?php echo $i; ?>][weight_class]"> 
									<option> Select </option>
									<option> Items 1</option>
									<option> Items 2</option>
								</select>
							</li>
							<li>
								<label>  Age Group	</label>
								<select class="medium" name="data[Wod][<?php echo $i; ?>][age_group]"> 
									<option>  Select  </option>
									<option> Items 1</option>
									<option> Items 2</option>
								</select>
							</li>
						</ul>
					</div>
					
					<div class="clear"> </div>
					<div class="left-section wod_details_<?php echo $i; ?>">
					
					<?php $j=1;
						foreach($eventWod as $division_type => $data) { 
							
							foreach($data as $division_sex => $details) { 
								
								$k=1;
								foreach($details as $info) {
						//for( $i = ($data['div_count'] + 1); $i < ($data['num_wods'] + $data['div_count'] + 1); $i++ )
						  //{
					 ?>
						<section class="wod-colum">
							<div class="header">
								<h3>WOD #<?php echo $k; ?></h3>
								<div class="select-box pull-right">
									<select class="small wods_select wod_select_<?php echo $k; ?>" onchange="get_wod_details(<?php echo $info['wod_id']; ?>, <?php echo $k; ?> ,<?php echo $info['wod_id']; ?>, '<?php echo $division_type; ?>', '<?php echo $division_sex; ?>');" > 
																				
										<?php foreach($allwods as $allwd){ ?>
											<option value="<?php echo $allwd['Wod']['id']; ?>" <?php if($allwd['Wod']['id'] == $info['wod_id']) echo 'selected'; ?>> <?php echo $allwd['Wod']['title']; ?></option>
										<?php } ?>
										
									</select>
									<div class="blue">
										<button onclick="return create_custom_wod(<?php echo $k; ?>. ,<?php echo $info['wod_id']; ?>, '<?php echo $division_type; ?>', '<?php echo $division_sex; ?>');">CUSTOM WOD</button>
									</div>
								</div>
							<div class="clear"></div>
							</div>
							<div class="inner-content <?php echo 'wod_'.$k.'_'.$info['wod_id']; ?>">
									<p class="underline"> <?php echo strip_tags($info['Wod']['description']); ?> &nbsp; </p>
							
							<?php
								$m = 0;
								$count_movement = count($info['WodMovement']);
								
								foreach($info['WodMovement'] as $mov){ 									
									if(!empty($mov['Movement'])) { 
								?>		
							<ul class="inner-select">
								<li>
									<label>  Movement : <?php echo $mov['Movement']['title']; ?>	</label>
								</li>
								<li>
									<label>
										<?php echo $mov['type'];
												if(!empty($mov['sub_type']))
												{
													echo '(in '.$mov['sub_type'].')';	
												}	
										?>	
									 </label>
									 
									 <input type="hidden" name="data[Wod][<?php echo $k; ?>][Movement][<?php echo $m; ?>][wod_id]" value="<?php echo $info['Wod']['id']; ?>" />
									 <input type="hidden" name="data[Wod][<?php echo $k; ?>][Movement][<?php echo $m; ?>][division_type]" value="<?php echo $division_type; ?>" />
									 <input type="hidden" name="data[Wod][<?php echo $k; ?>][Movement][<?php echo $m; ?>][division_sex]" value="<?php echo $division_sex; ?>" />
									 <input type="hidden" name="data[Wod][<?php echo $k; ?>][Movement][<?php echo $m; ?>][movement_id]" value="<?php echo $mov['Movement']['id']; ?>" />
									 <input type=text name="data[Wod][<?php echo $k; ?>][Movement][<?php echo $m; ?>][value]" class="required number" value="<?php echo $info['value']; ?>" />
									
								</li>
							</ul>
							
							<div class="clear"></div>
							
							<?php if($m != ($count_movement - 1)) { ?>
							 <span class="plus"> </span>
							<?php 
									} 
									$m++; }} 
							?>
							
															
							</div>
							
						</section> <!--first section ends-->
						
						
						<?php 
						
							$k++; }
						$j++; }
					}
						
						?>
						<?php } ?>
					 </div> <!-- left section ends -->
					 
				
					<div class="clear"></div>
					<!--<div class="blue mr10 mb25 fLeft">
						<button type="submit">EDIT </button>
					</div>-->
					<div class="blue mr10 mb25 fLeft wod_buttons_<?php echo $i;  ?>">
						<button onclick="return toggle_wod(<?php echo $i; ?>);">SAVE </button>
					</div>
					<div class="blue mb25 fLeft wod_buttons_<?php echo $i;  ?>">
						<button onclick="return remove_wod(<?php echo $i; ?>);">DELETE </button>
					</div>
</section>
                                    
  
									 
									 <?php $i++; }  ?>
								</div>
								<div class="clear"></div>
							</div>
						</div>
						
						<?php echo $this->Form->end(); ?>					
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- MId Section End -->

<?php 
	echo $this->element('custom_wod_popup'); 
	echo $this->element('invite_athlete_popup'); 
?>
	
<script type="text/javascript">

$(document).ready(function(){
	
	google.maps.event.addDomListener(window, 'load', initialize('location', 'map-canvas'));
	$('#EventCounterPricing').val(<?php echo count($event['Eventprice']); ?>);
	$('.datepick').datepicker({ minDate: 0, dateFormat:"yy-mm-dd" });
	$('#division_count').val(<?php echo count($event['EventWod']); ?>);
	$('#number_of_wods').val(1);
		
	//add_division();
	
});


function check_event_type(value)
{
	if(value == "challenge") 
	{
		$('#duration_div').show();
	}else{
		$('#duration_div').hide();
	}	
}

function add_pricing_div()
{
	var num = $('#EventCounterPricing').val();
	num = parseInt(num) + 1;
	$('ul.pricing:last').after('<ul class="two-columns pricing price_box_'+num+' clear-after"><li><label for="Eventprice'+num+'Price">Pricing</label><input type="text" id="Eventprice'+num+'Price" class="required number" name="data[Eventprice]['+num+'][price]"></li><li class="with-calendar"><label for="Eventprice'+num+'Date">Date</label><input type="text" id="Eventprice'+num+'Date" class="required datepick" name="data[Eventprice]['+num+'][date]" readonly="readonly"> <a href="javascript://" onclick="remove_pricing_div('+num+')"> &nbsp; </a></a></li></ul>');
	$('#EventCounterPricing').val(num);
	$('.datepick').datepicker({ minDate: 0, dateFormat:"yy-mm-dd" });
}

function remove_pricing_div(num)
{
	$('.price_box_'+num).remove();	
}

function add_division()
{
	var event_id = $('#event_id').val();
	var division = $('#division').val();
	var division_sex = $('#division_sex').val();
	var num_wods = $('#number_of_wods').val();
	var div_count = $('#division_count').val();
	
	$.post('<?php echo $this->webroot; ?>events/add_division',{ division:division, division_sex: division_sex, num_wods: num_wods, div_count: div_count}, function(data) {
		$('.division_section').after(data);
		$('#division_count').val(parseInt(div_count)+1);
	});
	
}

function readURL(input) {
	
	if (input.files[0] && input.files[0]) {
		var reader = new FileReader();

		reader.onload = function (e) {
			$('#img_prev').attr('src', e.target.result).width(70).height(70);
		};

		reader.readAsDataURL(input.files[0]);
	}
}

function invite_athlete_popup()
{
	$('.invite_athlete_box').fadeIn();
	get_people();
	scrollToAnchor('.invite_athlete_box');
}

function get_people()
{
	$.post('<?php echo $this->webroot; ?>events/get_people',function(data){
		$('.people_div').html(data);
		$('.loading_div').hide();	
	});	
}



</script>	
