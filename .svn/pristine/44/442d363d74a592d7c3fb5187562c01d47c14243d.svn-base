<?php 

App::uses('Controller', 'Controller');

/**
 * Messages Controller
 *
 * Purpose : Manage messages
 * @project Crossfit
 * @since 30 June 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class MessagesController extends AppController 
{
	public $name = 'Messages';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('Message', 'User');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();
		$this->Auth->allow('display_message_popup','send_message');
	}
	
	
	/**
	 * Method Name : display_message_popup
	 * Author Name : Vivek Sharma
	 * Date : 30 June 2014
	 * Description : display message popup
	 */
	 public function display_message_popup($username = null)
	 {
	 	$this->layout = 'ajax';
		
		$user = $this->User->find('first', array('conditions' => array('User.username' => $username),
												'fields' => array('User.id','User.email')));
		$this->set('user',$user);
		$this->render('message_popup');	
	 }
	 
	 
	 
	/**
	 * Method Name : send_message
	 * Author Name : Vivek Sharma
	 * Date : 30 June 2014
	 * Description : send message
	 */
	 public function send_message()
	 {	
	 	
	 	$this->layout = 'ajax';
		
		if ( !empty($this->request->data) )
		{
			$data = $this->data;
			$to_user = $this->User->find('first',array('conditions' => array('User.id' => $data['Message']['to_id']),
														'fields' => array('User.email')));
			
			
			if ( !empty($data['Message']['from_id']) )
			{
				$user = $this->User->find('first',array('conditions' => array('User.id' => $data['Message']['from_id']),
														'fields' => array('User.email')));
				$from_email = $data['Message']['from_email'] = $user['User']['email'];										
			
			}else{
				$from_email = $data['Message']['from_email'];
			}
			
			$data['Message']['ip_address'] = $this->request->clientIp();
			$data['Message']['created'] = date('Y-m-d H:i:s');
			
			$this->Message->create();
			if ( $message = $this->Message->save($data) )
			{
				/* Send email to user */
				$this->loadModel('Emailtemplate');
				$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 'reply_to', 'subject', 'content'), 'conditions' => array('email_for' => 'Message')));
				$content = $email_content['Emailtemplate']['content'];
				
				$content = str_replace(array('{USERNAME}', '{FROM}', '{SUBJECT}', '{CONTENT}'), array(ucfirst($data['User']['first_name']), $data['Message']['from_first_name'].' '.$data['Message']['from_last_name'] ,$data['Message']['subject'], $data['Message']['message']), $content);
				$email_content['Emailtemplate']['content'] = $content;
				
				$email = new CakeEmail('smtp');
				$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
				->to($to_user['User']['email'])
				->emailFormat('html')
				->subject($email_content['Emailtemplate']['subject'])
				->send($content);										
						
				echo 'success'; 
			}else{
				echo 'error';
			}
			die;
		}
		
		$this->render('message_popup');	
	 }
	 
	 
	 /**
	 * Method Name : reply_popup
	 * Author Name : Vivek Sharma
	 * Date : 1 July 2014
	 * Description : display reply message popup
	 */
	 public function reply_popup($message_id)
	 {
	 	$this->layout = 'ajax';
		
		$this->Message->bindModel(array(
									'belongsTo' => array(
											'User' => array(
													'className' => 'User',
													'foreignKey' => 'from_id'
											)
									)
								));
		$message = $this->Message->find('first', array('conditions' => array('Message.id' => $message_id)));
		
		$this->set('message', $message);
		$this->render('reply_popup');	
	 }

	/**
	 * Method Name : send_reply
	 * Author Name : Vivek Sharma
	 * Date : 1 July 2014
	 * Description : send reply to message
	 */
	 public function send_reply()
	 {
		if ( !empty($this->data) )
		{
			$data = $this->data;
			$data['created'] = date('Y-m-d H:i:s');
			$data['Message']['ip_address'] = $this->request->clientIp();
			
			$to_user = $this->User->find('first',array('conditions' => array('User.id' => $data['Message']['to_id']),
														'fields' => array('User.email')));
			
			$this->Message->create();
			if( $this->Message->save($data) )
			{
				/* Send email to user */
				$this->loadModel('Emailtemplate');
				$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 'reply_to', 'subject', 'content'), 'conditions' => array('email_for' => 'Message')));
				$content = $email_content['Emailtemplate']['content'];
				
				$content = str_replace(array('{USERNAME}', '{FROM}', '{SUBJECT}', '{CONTENT}'), array(ucfirst($data['User']['first_name']), $data['Message']['from_first_name'].' '.$data['Message']['from_last_name'] ,$data['Message']['subject'], $data['Message']['message']), $content);
				$email_content['Emailtemplate']['content'] = $content;
				
				$email = new CakeEmail('smtp');
				$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
				->to($to_user['User']['email'])
				->emailFormat('html')
				->subject($email_content['Emailtemplate']['subject'])
				->send($content);		
				echo 'success'; 
			}else{
				echo 'error';
			}
			die;
		} 	 	

	 }	 
	 
	
	 
}		
	 	