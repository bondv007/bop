<?php 

App::uses('Controller', 'Controller');

/**
 * Affiliate Controller
 *
 * Purpose : Manage Affiliate
 * @project Creators Exchange
 * @since 4 June 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class AffiliateController extends AppController 
{
	public $name = 'Affiliate';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('User','AffiliateProfile','Region','Coach');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();	
		$this->Auth->allow(array('accept_coach_invite','decline_coach_invite'));	
	}
	
	
	/**
	 * Method Name : manage_profile	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to manage affiliate profile
	 */
	 public function manage_profile()
	 {
		if ( !empty($this->request->data) )
		{	
			$data = $this->data;
			
			if ( empty($data['AffiliateProfile']['id']) )
			{
				$this->AffiliateProfile->create();	
			
			} else {
				
				$data['AffiliateProfile']['last_modified'] = date('Y-m-d H:i:s');
				$this->AffiliateProfile->id = $data['AffiliateProfile']['id'];
			}
						
			$this->AffiliateProfile->save($data['AffiliateProfile']);
			
			if ( empty($data['User']['photo']) || empty($data['User']['photo']['tmp_name']) || $data['User']['photo']['size'] > 0)
			{
				unset($data['User']['photo']);	
			}
			
			$this->User->id = $data['User']['id'];
			$this->User->save($data['User']);
			
			$this->redirect(array('controller' => 'users', 'action' => 'profile'));
									
		} 		 
		 
		$user_id = $this->Auth->user('id');
	
		$this->User->bindModel(array('hasOne' => array('AffiliateProfile' => array('className' => 'AffiliateProfile', 'foreignKey' => 'user_id'))));
		$user = $this->User->find('first', array('conditions' => array('User.id' => $user_id)));		
	
		$coaches = $regions = array();		
		
		$this->Coach->bindModel(array('belongsTo' => array('User' => array('className' => 'User', 'foreignKey' => 'user_id'))));
		$allcoaches = $this->Coach->find('all',array('conditions' => array('Coach.affiliate_id' => $user_id)));
		
		if ( !empty($allcoaches) )
		{
			foreach($allcoaches as $ach)
			{
				$coaches[$ach['Coach']['id']] = $ach['User']['first_name'].' '.$ach['User']['last_name'];	
			}	
		}		
		
		$regions = $this->Region->find('list',array('order' => array('Region.name' => 'asc')));
		
		$this->request->data = $user; 
		$this->set('regions', $regions);
		$this->set('coaches',$coaches);				
		$this->set('user', $user);	
		
		$this->render('manage_profile');				
					
	 }	 
	 
	 
	 /**
	 * Method Name : manage_coaches	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to manage coaches
	 */
	 public function manage_coaches()
	 {
		
		$this->paginate = array(
							'conditions' => array('Coach.affiliate_id' => $this->Auth->user('id'), 'User.status' => '1'),
							'limit' => '20',
							'order' => array('User.first_name' => 'asc'),
							'joins' => array(
									array(
										'table' => 'users', 'alias' => 'User', 'type'=>'inner', 'conditions'=>array('User.id = Coach.user_id')
									)
							)
						);
		
		$coaches = $this->paginate('Coach');
		$this->set('coaches', $coaches);
		$this->render('manage_coaches');
	 }
	 
	 
	 /**
	 * Method Name : add_coaches	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to add new coaches
	 */
	 public function add_coach()
	 {
	
		$this->render('add_coach');	
	 }
	 
	 /**
	 * Method Name : get_users_for_coach	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to get users to invite as coach
	 */
	 public function get_users_for_coach()
	 {
		$key = $this->request->query['term']; 
		
		$allusers = $this->User->find('all',array('conditions' => array('OR' => array('User.first_name LIKE ' => '%'.$key.'%', 'User.last_name LIKE ' => '%'.$key.'%'),'User.user_type IN ' => array('affiliate','coach','athlete'),'User.status' => '1'),
												'fields' => array('User.id','User.first_name','User.last_name','User.photo')));
		
		$users = array(); $i=0;
		
		foreach($allusers as $us)
		{
			$users[$i]['label'] = $us['User']['first_name'].' '.$us['User']['last_name'];
			$users[$i]['value'] = $us['User']['id'];
			
			$users[$i]['photo'] = $us['User']['photo'];	
			$i++;
		}
		echo json_encode($users);	die;
	 }
	 
	 
	 /**
	 * Method Name : invite_user	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to send invitation mail to GameOn user to connect as coach
	 */
	 
	 public function invite_user()
	 {
		$user = $this->User->findById($this->data['id']);
		
		if (!empty($user) )
		{
			$affiliate_name = $this->Auth->user('first_name');		
			
			$arr = array(
					'user_id' => $user['User']['id'],
					'affiliate_id' => $this->Auth->user('id'),
					'first_name' => $user['User']['first_name'],
					'last_name' => $user['User']['last_name'],
					'email' => $user['User']['email'],
					'photo' => $user['User']['photo'],
					'profile_link' => Router::url('/', true).'/coach/profile/'.$user['User']['id'],
					'status' => 'Pending',
					'token' => String::uuid()
					
				);
			
			$this->Coach->create();
			$coach = $this->Coach->save($arr);
			
			/* Send email to user */
			$this->loadModel('Emailtemplate');
			$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 'reply_to', 'subject', 'content'), 'conditions' => array('email_for' => 'Invite_gameon_coach')));
			$content = $email_content['Emailtemplate']['content'];
			$accept_url = '<a href="'.Router::url(array('controller' => 'affiliate', 'action' => 'accept_coach_invite', $coach['Coach']['token']), true).'">Click here </a>';
			$decline_url = '<a href="'.Router::url(array('controller' => 'affiliate', 'action' => 'decline_coach_invite', $coach['Coach']['token']), true).'">Click here </a>';
			
			$content = str_replace(array('{USERNAME}', '{ACCEPT_LINK}', '{DECLINE_LINK}', '{AFFILIATE}'), array(ucfirst($user['User']['first_name']),$accept_url, $decline_url, $affiliate_name), $content);
			$email_content['Emailtemplate']['content'] = $content;
			
			$email = new CakeEmail('smtp');
			$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
				->to($coach['Coach']['email'])
				->emailFormat('html')
				->subject($email_content['Emailtemplate']['subject'])
				->send($content);	
		}	
		die;
	 }
	 
	 
	 /**
	 * Method Name : accept_coach_invite	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : accept coach invitation
	 */
	 public function accept_coach_invite($key='')
	 {
		if ( !empty($key) )
		{
			$coach = $this->Coach->find('first',array('conditions' => array('Coach.token' => $key)));
			
			if ( !empty($coach) )
			{
				if ( $coach['Coach']['status'] == 'Pending' )
				{
					$this->Coach->id = $coach['Coach']['id'];
					$this->Coach->save(array('status' => 'Approved'));	
					
					$affiliate = $this->User->findById($coach['Coach']['affiliate_id'],array('first_name','last_name','email'));
					
					/* Send email to user */
					$this->loadModel('Emailtemplate');
					$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 'reply_to', 'subject', 'content'), 'conditions' => array('email_for' => 'response_coach_invitation')));
					$content = $email_content['Emailtemplate']['content'];
					
					$content = str_replace(array('{USERNAME}', '{COACH}', '{RESPONSE}'), array(ucfirst($affiliate['User']['first_name']), $coach['Coach']['first_name']. ' ' . $coach['Coach']['last_name'], 'accepted' ), $content);
					$email_content['Emailtemplate']['content'] = $content;
					
					$email = new CakeEmail('smtp');
					$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
						->to($affiliate['User']['email'])
						->emailFormat('html')
						->subject($email_content['Emailtemplate']['subject'])
						->send($content);
					
					$message = 'approved';
					
				} else {
					
					$message = 'already';						
				}
			} else {
				$message = 'invalid';	
			}	
		} else {
			$message = 'invalid';	
		}	
		
		$this->set('message',$message);
		$this->render('invitation_response_page');
	 }
	 
	 /**
	 * Method Name : decline_coach_invite	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : accept coach invitation
	 */
	 public function decline_coach_invite($key='')
	 {
		if ( !empty($key) )
		{
			$coach = $this->Coach->find('first',array('conditions' => array('Coach.token' => $key)));
			
			if ( !empty($coach) )
			{
				if ( $coach['Coach']['status'] != 'Pending' )
				{
					$this->Coach->id = $coach['Coach']['id'];
					$this->Coach->save(array('status' => 'Approved'));	
					
					$affiliate = $this->User->findById($coach['Coach']['affiliate_id'],array('first_name','last_name','email'));
					
					/* Send email to user */
					$this->loadModel('Emailtemplate');
					$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 'reply_to', 'subject', 'content'), 'conditions' => array('email_for' => 'response_coach_invitation')));
					$content = $email_content['Emailtemplate']['content'];
					
					$content = str_replace(array('{USERNAME}', '{COACH}', '{RESPONSE}'), array(ucfirst($affiliate['User']['first_name']), $coach['Coach']['first_name']. ' ' . $coach['Coach']['last_name'], 'declined' ), $content);
					$email_content['Emailtemplate']['content'] = $content;
					
					$email = new CakeEmail('smtp');
					$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
						->to($affiliate['User']['email'])
						->emailFormat('html')
						->subject($email_content['Emailtemplate']['subject'])
						->send($content);
					
					
					$message = 'declined';
					
				} else {
					
					$message = 'already';						
				}
			} else {
				$message = 'invalid';	
			}	
		} else {
			$message = 'invalid';	
		}	
		
		$this->set('message',$message);
		$this->render('invitation_response_page');
		
	 }
	 
	 
	 
	 /**
	 * Method Name : invite_new_user	 
	 * Author Name : Vivek Sharma
	 * Date : 4 June 2014
	 * Description : used to send invitation mail to new user to connect as coach
	 */
	 
	 public function invite_new_user()
	 {
		 pr($this->data); die;
		
		die;
	 }
	 
}	 
