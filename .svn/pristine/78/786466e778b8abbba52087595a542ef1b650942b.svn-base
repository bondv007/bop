<?php 

App::uses('Controller', 'Controller');

/**
 * Messages Controller
 *
 * Purpose : Manage messages
 * @project Crossfit
 * @since 30 June 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class MessagesController extends AppController 
{
	public $name = 'Messages';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('Message', 'User');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();
		$this->Auth->allow('display_message_popup','send_message');
	}
	
	
	/**
	 * Method Name : display_message_popup
	 * Author Name : Vivek Sharma
	 * Date : 30 June 2014
	 * Description : display message popup
	 */
	 public function display_message_popup($username = null)
	 {
	 	$this->layout = 'ajax';
		
		$user = $this->User->find('first', array('conditions' => array('User.username' => $username),
												'fields' => array('User.id','User.email')));
		$this->set('user',$user);
		$this->render('message_popup');	
	 }
	 
	 
	 
	/**
	 * Method Name : send_message
	 * Author Name : Vivek Sharma
	 * Date : 30 June 2014
	 * Description : send message
	 */
	 public function send_message()
	 {	
	 	
	 	$this->layout = 'ajax';
		
		if ( !empty($this->request->data) )
		{
			$data = $this->data;
			
			if ( !empty($data['Message']['from_id']) )
			{
				$user = $this->User->find('first',array('conditions' => array('User.id' => $data['Message']['from_id']),
														'fields' => array('User.email')));
				$from_email = $data['Message']['from_email'] = $user['User']['email'];										
			
			}else{
				$from_email = $data['Message']['from_email'];
			}
			
			$data['Message']['ip_address'] = $this->request->clientIp();
			$data['Message']['created'] = date('Y-m-d H:i:s');
			//pr($data); die;
			$this->Message->create();
			if ( $this->Message->save($data) )
			{
				echo 'success'; 
			}else{
				echo 'error';
			}
			die;
		}
		
		$this->render('message_popup');	
	 }
	 
	 
	 public function get_message($id)
	 {
	 	$this->layout = 'ajax';
	 	$message = $this->Message->find('first', array('conditions' => array('Message.id' => $id)));
		$this->set('message', $message);
		$this->render('reply_message_form');
	 }
	 
}		
	 	