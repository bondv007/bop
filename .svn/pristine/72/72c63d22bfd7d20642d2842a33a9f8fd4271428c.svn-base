<?php 

App::uses('Controller', 'Controller');

/**
 * Events Controller
 *
 * Purpose : Manage events
 * @project Creators Exchange
 * @since 21 May 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class EventsController extends AppController 
{
	public $name = 'Events';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('Event', 'Eventprice', 'Wod', 'WodMovement', 'Movement', 'EventWod','EventRegistration', 'User');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();
		$this->Auth->allow('index', 'event_details', 'event_registration', 'filter_events');
	}
	
	
	/**
	 * Method Name : index
	 * Author Name : Vivek Sharma
	 * Date : 27 May 2014
	 * Description : display all upcoming events on frontend
	 */
	 public function index()
	 {
		// Get all upcoming event locations
		$locations = $this->Event->find('all',array('conditions' => array('Event.start_date >= ' => date('Y-m-d'), 'Event.status' => '1'), 
													'fields' => array('Event.location')));	
		
		$event_locations = array();
		
		if ( !empty($locations) )
		{
			foreach($locations as $loc)
			{
				if ( !in_array( $loc['Event']['location'], $event_locations ) )
				{
					$event_locations[] = $loc['Event']['location'];	
				}
			}
		}										
		
		 $this->paginate = array('conditions' => array('Event.start_date >= ' => date("Y-m-d"), 'Event.status' => '1'),
		 						 'limit' => '6',
								  'order' => array('Event.start_date' => 'asc')
							 	);
		
		 $events = $this->paginate('Event'); 
		 
		 $map_data = array(); 
		 
		 if ( !empty($events) )
		 {
			$i=0;
			
			foreach($events as $ev)
			{
				$map_data[$i]['title'] = $ev['Event']['title'];
				$map_data[$i]['address'] = $ev['Event']['location'];
				$map_data[$i]['type'] = $ev['Event']['event_type'];	
				$i++;
			}	
		 } 	
		
		 $this->set('map_data', json_encode($map_data));
		 $this->set('events', $events);
		 $this->set('locations', $event_locations);
	 }
	 
	 
	 /**
	 * Method Name : filter_events
	 * Author Name : Vivek Sharma
	 * Date : 28 May 2014
	 * Description : filter events depending upon type, date, location
	 */
	 public function filter_events()
	 {	
		
		if($this->request->is('post'))
		{
			
			$this->layout = 'ajax';
			$data = $this->data;
			
			$conditions = array('Event.status' => '1');
			
			// event type filter
			if( isset($data['event_type']) && !empty($data['event_type']) )
			{
				$conditions[] = "`Event.event_type` = '".$data['event_type']."'"; 
			}	
			
			// event location filter
			if( isset($data['event_location']) && !empty($data['event_location']) )
			{
				$conditions[] = "`Event.location` = '".$data['event_location']."'"; 
			}	
			
			// event date filter
			if( isset($data['event_date']) && !empty($data['event_date']) )
			{
				$conditions[] = "`Event.start_date` >= '".$data['event_date']."'"; 
			}	
			
			$this->paginate = array('conditions' => $conditions,
		 						 'limit' => '6',
								  'order' => array('Event.start_date' => 'asc')
							 	);
		
			$events = $this->paginate('Event'); 
			
			$this->set('data',$data);
			$this->set('events', $events);
			$this->render('filtered_events');
		}	
	 }
	 
	
	/**
	 * Method Name : create_event
	 * Author Name : Vivek Sharma
	 * Date : 21 May 2014
	 * Description : used to create new event
	 */
	public function create_event()
	{
		if ( $this->request->is('post') )
		{
			$data=$this->request->data;
			
			$data['Event']['user_id']=$this->Auth->user('id');
			
			if($data['Event']['event_type'] == 'challenge')
			{
			
				if($data['Event']['duration_type'] == 'weeks')
				{
					$data['Event']['duration'] = (int)$data['Event']['duration']*7;	
					
				}else if($data['Event']['duration_type'] == 'months')
				{
					$data['Event']['duration'] = (int)$data['Event']['duration']*30;		
				}		
			}
			else
			{
				$data['Event']['duration'] = '';	
			}	
			
			$this->Event->set($data);
			
			if($this->Event->validates())
			{
				$this->Event->create();
				
				if($event=$this->Event->save($data))
				{
					if(!empty($data['Eventprice']))
					{
						$i=0; 
						$event_price = array();
						
						foreach($data['Eventprice'] as $price)
						{
							$event_price[$i] = $price;
							$event_price[$i]['event_id'] = $event['Event']['id'];	
							$i++;
						}	
						
						$this->Eventprice->create();
						$this->Eventprice->saveAll($event_price);
						
					}				
					
					if(!empty($data['Wod']))
					{
						$j=0;
						$wod_data = array();
						
						foreach($data['Wod'] as $wod)
						{
							foreach($wod['Movement'] as $wd)
							{
								$wod_data[$j] = $wd;
								$wod_data[$j]['event_id'] = $event['Event']['id'];
								$j++;
							}
						}						
						
						if(!empty($wod_data))
						{
							$this->EventWod->create();
							$this->EventWod->saveAll($wod_data);	
						}
					}
					
					if(isset($data['People']) && !empty($data['People']))
					{
						$this->Invite_people($event['Event']['id'],$data['People']);	
					}
					
					$this->Session->setFlash(__('Event saved successfully.'),'default',array(),'success');							
					$this->redirect(array('controller'=>'users'));
					
				}else{
					
					$this->Session->setFlash(__('Event not saved. Please try again'),'default',array(),'error');		
				}
			}else{
				
				$this->Session->setFlash(__($this->Event->validationErrors),'default',array(),'error');
			}			
		}	
	
		// get WOD category list
		$this->loadModel('Category');
		$categories = $this->Category->find('list',array('conditions' => array('Category.type' => 'wod') ));
		
		// get WOD types list
		$this->loadModel('WodType');
		$types = $this->WodType->find('list',array('conditions' => array('WodType.parent_id' => 0) ) );
		
		// get movements list
		$movements = $this->Movement->find('list');
		
		$this->set(compact('categories','types', 'movements'));
	}
	
	
	/**
	 * Method Name : add_division
	 * Author Name : Vivek Sharma
	 * Date : 21 May 2014
	 * Description : used to display new division wod blocks
	 */
	public function add_division()
	{
			$this->layout = 'ajax';
			
			$this->Wod->recursive = 2;
			$this->WodMovement->bindModel(array('belongsTo'=>array('Movement'=>array('className'=>'Movement','foreignKey'=>'movement_id'))));
			$this->Wod->bindModel(array('hasMany'=>array('WodMovement'=>array('className'=>'WodMovement','foreignKey'=>'wod_id'))));
			$wods = $this->Wod->find('all',array('order' => array('Wod.title'=>'asc')));
			
			$this->set('wods',$wods);
			$this->set('data',$this->data);
			$this->render('add_wod');
	}
	
	
	/**
	 * Method Name : get_wod_details
	 * Author Name : Vivek Sharma
	 * Date : 21 May 2014
	 * Description : used to display wod details and movements
	 */
	 public function get_wod_details()
	 {
			$this->layout = 'ajax';
			$wod_id = $this->data['wod_id'];
			
			$this->Wod->recursive = 2;
			$this->WodMovement->bindModel(array('belongsTo'=>array('Movement'=>array('className'=>'Movement','foreignKey'=>'movement_id'))));
			$this->Wod->bindModel(array('hasMany'=>array('WodMovement'=>array('className'=>'WodMovement','foreignKey'=>'wod_id'))));
			$wod = $this->Wod->find('first',array('conditions'=>array('Wod.id'=>$wod_id)));
			
			$this->set('wod',$wod);	
			$this->set('ctr',$this->data['ctr']);
			$this->set('division_sex',$this->data['division_sex']);
			$this->set('division',$this->data['division']);			
			$this->render('wod_details');	
	 }
	 
	 /**
	 * Method Name : get_by_type
	 * Author Name : Vivek Sharma
	 * Date : 21 May 2014
	 * Description : get sub type for WOD Type
	 */
	public function get_by_type() 
	{
		$this->layout = 'ajax';
		$type_id = $this->request->data['Wod']['type_id'];
 		$this->loadModel('WodType');
		$sub_types = $this->WodType->find('list', array(
			'conditions' => array('WodType.parent_id' => $type_id)
			));
		
		$data = '';
		
		foreach ($sub_types as $key => $value)
		{
			$data .= '<option value="'.$value.'">'.$value.'</option>';
		}	
		echo $data; die;
	}
	
	/**
	 * Method Name : save_custom_wod
	 * Author Name : Vivek Sharma
	 * Date : 21 May 2014
	 * Description : save custom WOD created by affiliate
	 */
	public function save_custom_wod()
	{
		if ($this->request->is('post'))
		{
			//pr($this->request->data);die;
			$this->Wod->create();
			if ($wod = $this->Wod->save($this->request->data))
			{
				$last_inserted_id = $wod['Wod']['id'];
				
				// Save WOD movements
				if ( isset($this->request->data['Wod']['movement_category']) && (isset($this->request->data['Wod']['movement_option'])) )
				{
					
					$movement_data = array();
					
					foreach ($this->request->data['Wod']['movement_category'] as $key => $value) {
						
						
						$type = $this->request->data['Wod']['movement_option'][$key];
						$total_value = 0; $sub_type = '';
						
						if ( $this->request->data['Wod']['option_data'][$key] != '')
						{
							$total_value = $this->request->data['Wod']['option_data'][$key];
						}
						
						if ( $type == 'distance'){
							
							$sub_type = $this->request->data['Wod']['movement_distance'][$key];	
													
						}else if ( $type == 'load'){
							
							$sub_type = $this->request->data['Wod']['movement_load'][$key];
						}
						
						$movement_data['WodMovement'][] = array(
															'wod_id' => $last_inserted_id,
															'movement_id' => $value,
															'type' =>  $type,
															'value' => $total_value,
															'sub_type' => $sub_type
														);
					}
					
					$this->WodMovement->saveAll($movement_data['WodMovement']);
				}
								
				$response = array('status' => 'success', 'ctr' => $this->request->data['Wod']['ctr'], 
									'num' => $this->request->data['Wod']['num'], 'wod_id' => $wod['Wod']['id'] ,
									'wod_title' => $wod['Wod']['title'], 'division' => $this->request->data['Wod']['division'], 
									'division_sex' => $this->request->data['Wod']['division_sex']);
							
			}else {
				
				$errors = $this->Wod->validationErrors;
				$response = array('status' => 'error', 'errors' => $errors);
				
			}
			echo json_encode($response); die;
		}
	
	}
	
	/**
	 * Method Name : get_people
	 * Author Name : Vivek Sharma
	 * Date : 23 May 2014
	 * Description : get people for event invitation
	 */
	public function get_people()
	{
		$this->layout = 'ajax';
		
		$conditions[] = array('User.id != ' => $this->Auth->user('id'), 'User.status' => STATUS_ACTIVE);
		if( isset( $this->data['keyword']))
		{
			$conditions[] = array( 'OR' => array( 'User.first_name LIKE "%'. $this->data['keyword'] . '%"',
													'User.last_name LIKE "%'. $this->data['keyword'] . '%"'));	
		}
		
		$this->loadModel('User');
		$users = $this->User->find('all',array('conditions' => $conditions,'limit' => 20, 'order' => array('User.first_name asc', 'User.last_name asc')));
		$this->set('users',$users);
		$this->render('people_for_invite');	
	}
	
	/**
	 * Method Name : Invite_people
	 * Author Name : Vivek Sharma
	 * Date : 23 May 2014
	 * Description : Invite people for event
	 */
	public function Invite_people($event_id, $arr)
	{
		return;	
	}
	
	
	/**
	 * Method Name : event_details
	 * Author Name : Vivek Sharma
	 * Date : 27 May 2014
	 * Description : display event details
	 */
	 public function event_details($event_id)
	 {
		if ( !empty($event_id) )
		{
			$this->Event->bindModel(array('hasMany' => array('Eventprice' => array('className' => 'Eventprice', 
																					'foreignKey' => 'event_id', 'order' => 'Eventprice.date asc'))));
			$event = $this->Event->findById($event_id);	
			
			$this->set('event',$event);
			$this->render('event_details');
		}
		else
		{
			$this->redirect(array('controller' => 'events', 'action' => 'index'));	
		}	
	 }
	 
	 /**
	 * Method Name : event_registration
	 * Author Name : Vivek Sharma
	 * Date : 27 May 2014
	 * Description : Registration for event
	 */
	 public function event_registration($event_id = null)
	 {
		if($this->request->is('post') && !empty($this->request->data))
		{
			$details = $this->data['EventRegistration'];
			$user_data = $this->data['User'];
			
			$arr = array();
			$arr['event_id'] = $details['event_id'];
			$arr['team_id'] = '';
			$arr['division'] = $details['division'];
			$arr['affiliate'] = $details['affiliate'];
			
			
			$user = $this->User->findByEmail($user_data['email']);
			
			if(empty($user))
			{
				
				$user_data['role'] = 'user';
				$user_data['user_type'] = 'athlete';
				$user_data['status'] = STATUS_ACTIVE ;
				
				$this->User->create();
				
				if ($user = $this->User->save($user_data) )
				{
					//update randomly generated user password 
					$lastInsertedId = $user['User']['id']; 
					$random_string = 'password';
					$user_data['password'] = $this->Auth->password($random_string);
					$this->User->saveField('password',$user_data['password']);
					
					
					$event_details = $this->Event->find('first',array('conditions' => array('Event.id' => $details['event_id']),
																	'fields' => array('Event.title')));
					
					/* Send email to user */
					$this->loadModel('Emailtemplate');
					$email_content = $this->Emailtemplate->find('first', array('fields' => array('from_name', 'from_email', 
																								'reply_to', 'subject', 'content'), 
																				'conditions' => array('email_for' => 'Event_registration')));
																				
					$content = $email_content['Emailtemplate']['content'];
				
					$content = str_replace(array('{USERNAME}', '{EVENT}' ,'{EMAIL}', '{PASSWORD}'), array(ucfirst($user['User']['first_name']), $event_details['Event']['title'], $user['User']['email'], $random_string), $content);
					$email_content['Emailtemplate']['content'] = $content;
					
					$email = new CakeEmail('smtp');
					$email->from(array (ADMIN_EMAIL => APPLICATION_NAME))
							->to($user['User']['email'])
							->emailFormat('html')
							->subject($email_content['Emailtemplate']['subject'])
							->send($content);
							
					$arr['user_id'] = $user['User']['id']; 		
						
				}else{
					$this->Session->setFlash(__('Please fill the required fields.'),'default',array(),'error');
					$this->redirect(array('controller' => 'users','action' => 'register'));	
				}				
						
			}else{

				
				// Update user details
				$this->User->id = $user['User']['id'];
				$this->User->save(array('date_of_birth' => $user_data['date_of_birth'], 'gender' => $user_data['gender']));
				
				$arr['user_id'] = $user['User']['id']; 
			}
			
			// Save registration information and update total event registrations
			if(isset($arr['user_id']) && !empty($arr['user_id']))
			{
				//create user session
				$this->Auth->login($user['User']);	
								
				//save registration data
				$this->EventRegistration->create();
				$registration = $this->EventRegistration->save($arr);					
				
				$event = $this->Event->find('first',array('conditions' => array('Event.id' => $details['event_id']),
														'fields' => array('Event.number_of_registrations')));
				
				//Increment number of registrations in an event
				$this->Event->id = $details['event_id'];
				$this->Event->saveField('number_of_registrations',((int)$event['Event']['number_of_registrations'] + 1));
				
				$this->redirect(array('controller' => 'events', 'action' => 'event_payment_details', $registration['EventRegistration']['id']));											
			}
		}
		
		if ( !empty($event_id) )
		{	
			$this->Event->recursive = 2;
			$this->EventWod->bindModel(array('belongsTo' => array('Wod' => array('className' => 'Wod', 'foreignKey' => 'wod_id'))));
			$this->Event->bindModel(array('hasMany' => array('Eventprice' => array('className' => 'Eventprice', 'foreignKey' => 'event_id', 
																						'order' => 'Eventprice.date asc'),
															'EventWod' => array('clasName' => 'EventWod', 'foreignKey' => 'event_id'))));
															
			$event = $this->Event->findById($event_id);	
			
			//find all affiliates
			$all_affiliates = $this->User->find('all',array('conditions' => array('User.user_type' => 'affiliate', 'User.status' => '1'),
														'fields' => array('User.first_name', 'User.last_name')));
			
			$affiliates = array();
			
			if( !empty($all_affiliates) )
			{
				foreach( $all_affiliates as $aff)
				{
					if( !in_array($aff['User']['first_name'].' '.$aff['User']['last_name'], $affiliates))
					{
						$affiliates[] = $aff['User']['first_name'].' '.$aff['User']['last_name'];	
					}	
				}
			}			
			
			$i=0;
			$divisions = array();
			if(!empty($event['EventWod']))
			{					
				foreach($event['EventWod'] as $wod) 
				{	
					$division[$wod['id']] = trim($wod['Wod']['title'].' - '.$wod['division_type']);
					$i++;
				}
			}
			
			$this->set('user', $this->Auth->user());
			$this->set('event',$event);
			$this->set('divisions',$division);
			$this->set('affiliates', json_encode($affiliates));
			$this->render('event_registration');
		}
		else
		{
			$this->redirect(array('controller' => 'events', 'action' => 'index'));	
		}		
		
	 }
	 
	 
	 /**
	 * Method Name : event_payment_details
	 * Author Name : Vivek Sharma
	 * Date : 27 May 2014
	 * Description : Payment details for event registration from frontend
	 */
	 
	 public function event_payment_details($register_id = null)
	 {
		
		if($this->request->is('post') && !empty($this->request->data))
		{
			//update payment status
			$this->EventRegistration->id = $this->data['Payment']['register_id'];
			$this->EventRegistration->saveField('payment_status', 'Paid');
			
			$this->redirect(array('controller' => 'events', 'action' => 'registration_success'));	
		}
		
		if(!empty($register_id))
		{
			$this->EventRegistration->primaryKey = 'event_id';
			$this->EventRegistration->bindModel(array('hasMany' => array('Eventprice' => array('className' => 'Eventprice', 'foreignKey' => 'event_id'))));
			$details = $this->EventRegistration->findById($register_id);	
			
			
			$this->set('details',$details);
			$this->render('event_payment_details');
		}
		else
		{
			$this->redirect(array('controller' => 'events', 'action' => 'index'));		
		}	
	 }
	 
	 /**
	 * Method Name : registration_success
	 * Author Name : Vivek Sharma
	 * Date : 27 May 2014
	 * Description : Event registration successful page
	 */
	 public function registration_success()
	 {
		
	 }
	
}

