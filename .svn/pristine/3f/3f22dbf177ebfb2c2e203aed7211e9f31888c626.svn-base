<?php 
 echo $this->Html->css(array('jquery-ui.custom')); 
 echo $this->Html->script(array('jquery-ui.custom','cycleall')); 

?>	
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>

	<!-- Slider -->
	<section class="athlt-profile-top row">
		<div class="page-mid events-map">
			<div class="athlt-banner-main row">
				<div class="bg-map"> 
                	<div class="upper-map-options">
                    	<div class="event-map"> AFFILIATES MAP </div>                        
                        	 <select id="affiliate_country_location" name="affiliate_country" class="dropdown" onchange="filter_affiliates(this.value);">
									<option value="">Country</option>
									<?php if(!empty($countries)){
											
											foreach($countries as $loc){ 
									?>									
										<option value="<?php echo $loc; ?>"><?php echo $loc; ?></option>
										
									<?php }} ?>
								</select>             
                        <div class="clear"></div> 
                    </div>             
				
                </div>
				<div id="map_canvas" style="margin-top:-20px;"></div>
			</div>
		</div>
	</section>
	<!-- Slider End -->
<div id="locs" style="display:none;"></div>

<!-- MId Section -->
	<section class="body-content-bg ptb25 row">
		<div class="page-mid event-colum">
			<div class="body-content-mn row mt10">
				
				<div class="row">					
					<div class="about-team">
                    <div class="event-bg">
						<h2>AFFILIATES</h2>		
                        <div class="clear"></div>
                    </div>    				
						<div class="inner-sponer event_list">
							
					<?php if(!empty($affiliates)){ 
							$k=1;
							foreach($affiliates as $region => $aff_data){ ?>
						
						<div class="sBox-head">
									<a href="#"><?php echo $region; ?></a>
						</div>			
						 <div class="slider_container_<?php echo $k; ?> region_box">				 
						<?php  	$j=0;		 
								for($i=0; $i<ceil(count($aff_data)/3); $i++){   ?>						
								
							<ul class="compition-sBox mt10">
									
								<?php if(isset($aff_data[$j])){ ?>
								<li>	
									<div class="colum <?php if($j == 0) { echo 'no-lm'; }?>" onclick="window.location='<?php echo ''; ?>'">
										<div class="image">
		                                	<div class="black-strip"><?php echo $aff_data[$j]['User']['other_name']; ?> </div>
											<a href="<?php echo ''; ?>">
												<img src="<?php echo $this->webroot.'files/'.$aff_data[$j]['User']['id'].'/'.$aff_data[$j]['User']['photo']; ?>" alt=""  />
											</a>
											
										</div>
										
									</div>
								</li>
								<?php } ?>
								
								<?php if(isset($aff_data[$j+1])){ ?>
								<li>	
									<div class="colum <?php if($j+1 == 0) { echo 'no-lm'; }?>" onclick="window.location='<?php echo ''; ?>'">
										<div class="image">
		                                	<div class="black-strip"><?php echo $aff_data[$j+1]['User']['other_name']; ?> </div>
											<a href="<?php echo ''; ?>">
												<img src="<?php echo $this->webroot.'files/'.$aff_data[$j+1]['User']['id'].'/'.$aff_data[$j+1]['User']['photo']; ?>" alt="" />
											</a>
											
										</div>
										
									</div>
								</li>
								<?php } ?>
								
								
								<?php if(isset($aff_data[$j+2])){ ?>
								<li>	
									<div class="colum <?php if($j+2 == 0) { echo 'no-lm'; }?>" onclick="window.location='<?php echo ''; ?>'">
										<div class="image">
		                                	<div class="black-strip"><?php echo $aff_data[$j+2]['User']['other_name']; ?> </div>
											<a href="<?php echo ''; ?>">
												<img src="<?php echo $this->webroot.'files/'.$aff_data[$j+2]['User']['id'].'/'.$aff_data[$j+2]['User']['photo']; ?>" alt="" />
											</a>
											
										</div>
										
									</div>
								</li>
								<?php } 								
									$j+=3; 	?>						
									
								</ul>		
								
							<?php 	} ?>
							</div>
							<ul class="row tCenter step_paging step_tabs_<?php echo $k; ?>">
								
							</ul>
							<script type="text/javascript">
							 $(document).ready(function(){	
	
								 $('.slider_container_<?php echo $k; ?>').cycle({
										speed: 1000,
										timeout:3000,
										fx: 'fade',
										pager: '.step_tabs_<?php echo $k; ?>',
										activePagerClass: 'active',
										pagerAnchorBuilder: function(idx, slide) {
											return '<li><a href="javascript://"></a></li>';
										}
									});
							});
							</script>
							<div class="clear"></div>
							<?php  $k++;  } }else{ ?>
							
								
							<div style="height: 150px; text-align:center;">
							<p style="margin-top:70px;">No affiliates found.</p>
							</div>
							
							<?php } ?>
													
					</div>
				
			</div>
		</div>
        </div>
		</div>
	</section>
	<!-- MId Section End -->
	<div id="locs" style="display:none;"></div>
<?php
	echo $this->Js->writeBuffer();
?>		
<script type="text/javascript">

var data = <?php echo $map_data; ?>;
var map;
var markers = [];
var lastinfowindow;
var locIndex;


$(document).ready(function(){
	
	initialize_all_event();
	 $('.slider_container').cycle({
			speed: 1000,
			timeout:4000,
			fx: 'fade',
			pager: '.step_tabs',
			activePagerClass: 'active',
			pagerAnchorBuilder: function(idx, slide) {
				return '<li><a href="javascript://"></a></li>';
			}
		});
	
});

function filter_affiliates(aff_country)
{
	if(aff_country != '')
	{
		console.log(aff_country);
		showLoading('.event_list','<?php echo $this->webroot.'images/loading.gif'; ?>');
		$.post('<?php echo $this->webroot; ?>affiliate/filter_affiliates',{country: aff_country }, function(response){
			
			$('.event_list').html(response);	
			doFilter();	
		});	
	}	
	
}

function initialize_all_event() 
{
	var latlng = new google.maps.LatLng(0, 0);
	var myOptions = {
		zoom: 2,
		minZoom: 2,
		center: latlng,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};	
	
	map = new google.maps.Map(document.getElementById("map_canvas"),myOptions);
	geocoder = new google.maps.Geocoder();
	
	data.forEach(function(mapData,idx) {
		geocoder.geocode( { 'address': mapData.address}, function(results, status) {
				
				if (status == google.maps.GeocoderStatus.OK) {
					
					var marker = new google.maps.Marker({
						map: map, 
						position: results[0].geometry.location,
						title: mapData.title
						//icon: getIcon(mapData.type)
					});
					var contentHtml = "<div style='width:150px;height:80px' class='map_tooltip'><h3>"+mapData.title+"</h3>"+mapData.address+"</div>";
					var infowindow = new google.maps.InfoWindow({
		    			content: contentHtml
					});
					google.maps.event.addListener(marker, 'click', function() {
					  infowindow.open(map,marker);
					});
					marker.locid = idx+1;
					marker.infowindow = infowindow;
					markers[markers.length] = marker;
					
					var sideHtml = '<p class="loc" data-locid="'+marker.locid+'"><b>'+mapData.title+'</b><br/>';
						 sideHtml += mapData.address + '</p>';
						 $("#locs").append(sideHtml); 
					
					//Are we all done? Not 100% sure of this
					if(markers.length == data.length) 
								doFilter();

				} else {
					//alert("Geocode was not successful for the following reason: " + status);
				}
			});

	});

	$(document).on("click",".loc",function() {
		var thisloc = $(this).data("locid");
		for(var i=0; i<markers.length; i++) {
			if(markers[i].locid == thisloc) {
				//get the latlong
				if(lastinfowindow instanceof google.maps.InfoWindow) lastinfowindow.close();
				map.panTo(markers[i].getPosition());
				markers[i].infowindow.open(map, markers[i]);
				lastinfowindow = markers[i].infowindow;
			}
		}
	});

	/*
	Run on every change to the checkboxes. If you add more checkboxes to the page,
	we should use a class to make this more specific.
	*/

	function doFilter() {
		if(!locIndex) {
			locIndex = {};
			//I reverse index markers to figure out the position of loc to marker index
			for(var x=0, len=markers.length; x<len; x++) {
				locIndex[markers[x].locid] = x;
			}
		}		
		
		//what's checked?
		var checked = $("input[type=radio]:checked");
		
		var selTypes = [];
		for(var i=0, len=checked.length; i<len; i++) {
			selTypes.push($(checked[i]).val());
		}
		for(var i=0, len=data.length; i<len; i++) {
			var sideDom = "p.loc[data-locid="+(i+1)+"]";
			
			//Only hide if length != 0
			if(checked.length !=0 && selTypes.indexOf(data[i].type) < 0) {
				$(sideDom).hide();
				markers[locIndex[i+1]].setVisible(false);
			} else {
				$(sideDom).show();
				markers[locIndex[i+1]].setVisible(true);
			}
		}
	}
	$(document).on("click", "input[type=radio]", doFilter);

}

</script>	
	
