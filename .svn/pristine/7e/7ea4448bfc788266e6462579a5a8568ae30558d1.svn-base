<?php 
	echo $this->Html->css(array('jquery-ui.custom')); 
	echo $this->Html->script(array('jeditable','jquery-ui.custom'));
 ?>	

<!-- Slider -->
	<section class="athlt-profile-top row">
		<div class="page-mid">
			<div class="filter-search row">
				<?php if($this->Session->check('Auth.User')){ ?>
				 <div class="blue fRight">
                	<button type="submit" onclick="window.location.href='<?php echo $this->webroot.'events/manage_events'; ?>'">Back to Events</button>
                </div>
                <?php } ?>
			</div>
		</div>
	</section>
	<!-- Slider End -->
	
	<!-- MId Section -->
	<section class="body-content-bg ptb25 row">
		<div class="page-mid">
			<div class="body-content-mn row mt10">
				
				<div class="row">
					<div class="register-columns">
					<div class="column">
							<div class="header">
								<h3>TFL Crossfit <?php echo $event['Event']['title']; ?></h3>								
							</div>														
						</div><!--.left-column-->
					</div>
					<div class="list-tabing">
						
						
					
						<div class="tab-content">
							
							<div class="filter-search row">
								
								<div class="div_filter">
									<select id="division_select" onchange="get_division_scoring(this.value);">
										<option value="">Select Division</option>
										<?php if(!empty($event['EventWod'])){
												$all_division = array();	 
												foreach($event['EventWod'] as $ew){
													if(!in_array($ew['division_type'], $all_division)){
											?>
												<option value="<?php echo str_replace(' ','_',$ew['division_type']); ?>"><?php echo $ew['division_type']; ?></option>
										<?php  $all_division[] = $ew['division_type']; }}} ?>	
									</select>
									
									<input type="text" id="search_users" placeholder="Search"/>
								</div>	
								
								
								<div class="scoring_options">
								<?php if($event['Event']['scoring_status'] == 'Open'){ ?>
									 <div class="blue fRight">
				                	<button class="red" onclick="toggle_scoring(0);">Close Scoring</button>
				                </div>
								<div class="blue fRight">
				                	<button class="score_edit_btn blue" onclick="toggle_editable();">Edit</button>
				                	<input type="hidden" id="editable_val" value="0"/>
				                </div>
				                
				               
				                <?php }else if($event['Event']['scoring_status'] == 'Not started'){ ?>
				                <div class="blue fRight">
				                	<button onclick="toggle_scoring(1);">Open Scoring</button>
				                	
				                </div>	
				                <?php } ?>	
								</div>				
							</div>
						<div class="clear"></div>
							
							
							
							<div id="competitions" class="tab-content-list">
								<table width="100%" border="0" cellspacing="0" id="data_table" cellpadding="0">
									<tr>		
										<th scope="col">Athlete</th>
										<th scope="col">Final</th>
									<?php if(!empty($event['EventWod'])){ 
											$wod_count = 1;
											foreach($event['EventWod'] as $wd){		
										?>
											<th scope="col" class="event_wod_<?php echo str_replace(' ','_',$wd['division_type']); ?> all_event_wod"><?php echo 'WOD '.$wod_count.'<br>'.$wd['Wod']['title']; ?></th>
										<?php $wod_count++; }} ?>										
									</tr>
									
								<?php 
									if ( !empty($event['EventRegistration']) ){
									$i=1;		
									$allusers = array();
									foreach($event['EventRegistration'] as $ev) { 
										
										if(!empty($ev['User']))
										{
											$name = $ev['User']['first_name'].' '.$ev['User']['last_name'];																						
											 
										}else{
											$name = $ev['first_name'].' '.$ev['last_name'];													
											 
										 }			
										$allusers[] = $name;
							?>
									<tr class="row_<?php echo str_replace(' ','_',$name); ?>">
										<td><?php  echo $name; ?></td>
										<td>
											<p id="register_<?php echo $ev['id']; ?>" class="editable final_score">
												<?php if(!empty($ev['final_score'])) echo $ev['final_score']; else echo '-'; ?>
											</p>
										</td>
									<?php 
										if(!empty($event['EventWod'])){ 
											$wod_count = 1;
											foreach($event['EventWod'] as $wd){
												$score_exist = 0;		
										?>
										<td class="event_wod_<?php echo str_replace(' ','_',$wd['division_type']); ?> all_event_wod">
											<p id="<?php echo 'score_'.$ev['id'].'_'.$wd['id']; ?>" class="editable"><?php if(!empty($ev['EventScore'])){ 
													foreach($ev['EventScore'] as $scr){
														if($scr['event_id'] == $event['Event']['id'] 
																		&& $scr['registration_id'] == $ev['id'] 
																					&& $scr['wod_id'] == $wd['id']){
																							$score_exist = 1;
																						echo $scr['score']; 
																					}
													}
											}else{
												echo '-';
											}	

												if($score_exist == 0)
												{
													echo '-';
												}
													
												?></p>
										</td>	
										<?php $wod_count++; }} ?>	
									</tr>
									<?php $i++; }} ?>
									
								</table>
							</div>
						</div>					
					</div>
					
			</div>
		</div>
	</section>
	<!-- MId Section End -->

<script type="text/javascript">
	$(document).ready(function(){
		
		instantiate_editable();
     
     
 var availableTags = <?php echo json_encode($allusers); ?>;
			
			$( "#search_users" ).autocomplete({
				source: availableTags,
				focus: function( event, ui ) {
					var disp=ui.item.label.replace(/ /g,"_");
					disp=disp.replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,"_");
					$( "#search_users" ).val( ui.item.label );
					var selectedDiv=$('.row_'+disp).clone();
					$('.row_'+disp).remove();
					$('#data_table').find('tr').eq(0).after(selectedDiv);
					
					instantiate_editable();
					
					 var edit_val = $('#editable_val').val();
					 if(edit_val == 0)
					 {
						$('.editable').editable('disable');
					    $('#editable_val').val(0);
					    $('.score_edit_btn').removeClass('blue');
						$('.score_edit_btn').addClass('red');
					 }
					return false;
			}
	});
     
     
	    $('.editable').editable('disable');
	    $('#editable_val').val(0);
	    $('.score_edit_btn').removeClass('blue');
		$('.score_edit_btn').addClass('red');
		$('#search_users').val('');
		
		var start = $('#division_select').find('option').eq(1).val();
		$('#division_select').find('option').eq(1).attr('selected','selected');
		get_division_scoring(start);
		
	});
	
	function toggle_editable()
	{
		 var edit_val = $('#editable_val').val();
		 if(edit_val == 0)
		 {
		 	$('.editable').editable('enable');
		 	$('#editable_val').val(1);
		 	$('.score_edit_btn').removeClass('red');
		 	$('.score_edit_btn').addClass('blue');
		 }else{
		 	$('.editable').editable('disable');
		 	$('#editable_val').val(0);
		 	$('.score_edit_btn').removeClass('blue');
		 	$('.score_edit_btn').addClass('red');
		 }
	}
	
	function toggle_scoring(val)
	{
		$.post('<?php echo $this->webroot.'events/toggle_scoring/'.$event['Event']['id'].'/'; ?>'+val, function(data){
			if(val == '1')
			{
				$('.scoring_options').html(data);
				
			}else{
				$('.scoring_options').remove();
				alert('Scoring has been closed.');
			}
			
		});
	}
	
	function get_division_scoring(val)
	{
		if(val!='')
		{
			$('.all_event_wod').hide();
			$('.event_wod_'+val).show();
		}
	}
	
	function instantiate_editable()
	{
		$('.editable').editable('<?php echo $this->webroot.'events/update_score/'.$event['Event']['id']; ?>', {
         indicator : 'Saving...',
         onblur : "submit",
         event : 'click',
         tooltip   : '',
         data    : function(string) {return $.trim(string)},
          onsubmit : function(settings,original){
          				if (original.revert == $('input',this).val()) {
					        original.reset();
					        return false;
					    }else{
					    	
					    	var input = $(original).find('input');				    	
							if($(original).hasClass('final_score'))
							{
								if(isNumeric(input.val()))
								 {
								 	return true;
								 }else{
								 	alert('Please enter valid number');
								 	return false;
								 }
							}				 
							
          				}
          	}
     });
	}
</script>