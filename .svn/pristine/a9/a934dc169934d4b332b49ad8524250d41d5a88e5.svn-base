<?php 

App::uses('Controller', 'Controller');

/**
 * Events Controller
 *
 * Purpose : Manage Stripe Accounts
 * @project Crossfit
 * @since 19 Aug 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class AccountsController extends AppController 
{
	public $name = 'Accounts';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('User');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();
	}


	public function connect()
	{
		if ( isset($this->request->query['code']) )
		{
			$code = $this->request->query['code'];
			
			
			$url = "https://connect.stripe.com/oauth/token";
			
			$fields = array(
							'client_secret' => STRIPE_TEST_SECRET,
							'code' => $code,
							'grant_type' => 'authorization_code'									
							);
			$fields_string = '';
			foreach($fields as $key=>$value) { $fields_string .= $key.'='.$value.'&'; }
			rtrim($fields_string, '&');
			
			$ch = curl_init();
			
			curl_setopt($ch,CURLOPT_URL, $url);
			curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
			curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
			curl_setopt($ch,CURLOPT_POST, count($fields));
			curl_setopt($ch,CURLOPT_POSTFIELDS, $fields_string);
			
			$result = curl_exec($ch);
			
			
			$data = json_decode($result);
			
			if ( isset($data->stripe_user_id) && isset($data->access_token) )
			{
				$arr = array(
						'stripe_user_id' => $data->stripe_user_id,
						'stripe_access_token' => $data->access_token,
						'stripe_refresh_token' => $data->refresh_token,
						'stripe_publishable_key' => $data->stripe_publishable_key 
					);
					
				$this->loadModel('User');
				$this->User->id = $this->Auth->user('id');
				$this->User->save($arr);
				
				$this->Session->setFlash(__('Congratulations! Your stripe account connected successfully.'),'default',array(),'success');			
				
			}else{
				$this->Session->setFlash(__('There is some issue. Please try to connect your stripe account later'),'default',array(),'error');		
			}
			
			$this->redirect(array('controller' => 'users', 'action' => 'index'));	
			
			
		}		
	}
	
}