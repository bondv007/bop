<?php 

App::uses('Controller', 'Controller');

/**
 * Athlete Controller
 *
 * Purpose : Manage Athlete
 * @project Crossfit
 * @since 29 July 2014
 * @version Cake Php 2.3.8
 * @author : Vivek Sharma
 */
 
class AthleteController extends AppController 
{
	public $name = 'Athlete';
	public $components = array('RequestHandler');
	public $helpers = array('Html', 'Form', 'Js');
	public $uses = array('User','AthleteProfile','Region','Athlete','Badge');
	
	public function beforeFilter()
	{		
		parent::beforeFilter();	
			
	}
	
	
	/**
	 * Method Name : manage_profile	 
	 * Author Name : Vivek Sharma
	 * Date : 29 July 2014
	 * Description : used to manage athlete profile
	 */
	 public function manage_profile()
	 {
		if ( !empty($this->request->data) )
		{	
			$data = $this->data;
			//pr($data); die;
			$username_exist = $this->User->find('count', array('conditions' => array('User.username' => $data['User']['username'],
																						'User.id != ' => $data['User']['id'])));
			
			if(empty($username_exist))
			{
				if ( empty($data['AthleteProfile']['id']) )
				{
					$this->AthleteProfile->create();	
				
				} else {
					
					$data['AthleteProfile']['last_modified'] = date('Y-m-d H:i:s');
					$this->AthleteProfile->id = $data['AthleteProfile']['id'];
				}
							
				$this->AthleteProfile->save($data['AthleteProfile']);
				
				if ( empty($data['User']['photo']) || empty($data['User']['photo']['tmp_name']) || $data['User']['photo']['size'] > 0)
				{
					unset($data['User']['photo']);	
				}
				
				$this->User->id = $data['User']['id'];
				$this->User->save($data['User']);
				
				$this->redirect(array('controller' => 'users', 'action' => 'profile'));
			}else{
				
				
				$this->Session->setFlash(__('Username already exist.'),'default',array(),'error');
			}
									
		} 		 
		 
		$user_id = $this->Auth->user('id');
	
		$this->User->bindModel(array('hasOne' => array('AthleteProfile' => array('className' => 'AthleteProfile', 'foreignKey' => 'user_id'))));
		$user = $this->User->find('first', array('conditions' => array('User.id' => $user_id)));		
	
		$regions = array();		
				
		$regions = $this->Region->find('list',array('order' => array('Region.name' => 'asc')));
		
		$this->request->data = $user; 
		
		$this->set('athlete_profile_id',$user['AthleteProfile']['id']);
		$this->set('regions', $regions);				
		$this->set('user', $user);	
		
		$this->render('manage_profile');				
					
	 }	 

	 /**
	 * Method Name : manage_badges	 
	 * Author Name : Vivek Sharma
	 * Date : 29 July 2014
	 * Description : used to manage badges
	 */
	 public function manage_badges()
	 {
		
		$this->paginate = array(
							'conditions' => array('Badge.user_id' => $this->Auth->user('id')),
							'limit' => '20'							
						);
		
		$badges = $this->paginate('Badge');
		$this->set('badges', $badges);
		$this->render('manage_badges');
	 } 
	 
	 /**
	 * Method Name : add_badge	 
	 * Author Name : Vivek Sharma
	 * Date : 29 July 2014
	 * Description : used to add a new badge
	 */
	 public function add_badge()
	 {
	 	if ( !empty($this->request->data) )
		{
			$this->Badge->create();
			if($badge = $this->Badge->save($this->data))
			{
				$this->Session->setFlash(__('New Badge saved.'),'default',array(),'success');
				$this->redirect(array('action' => 'manage_badges'));
			}else{
				$this->Session->setFlash(__('Badge not saved.'),'default',array(),'error');
			}		
		}
	 	$this->set('user_id',$this->Auth->user('id'));
	 	$this->render('add_badge');
	 }
	 
	 /**
	 * Method Name : delete_badge	 
	 * Author Name : Vivek Sharma
	 * Date : 29 July 2014
	 * Description : delete badge
	 */
	 public function delete_badge($id)
	 {
	 	if ( !empty($id) )
		{
			$badge = $this->Badge->findById($id);
			if ( !empty($badge) )
			{
				$this->Badge->delete($id);
				unlink($this->webroot.'files/badges/'.$id);
				$this->Session->setFlash(__('Badge removed successfully.'),'default',array(),'success');
			}else{
				$this->Session->setFlash(__('Badge not found.'),'default',array(),'error');
			}
		}else{
			$this->Session->setFlash(__('Invalid request.'),'default',array(),'error');
		}
		$this->redirect($this->referer());
	 }
	 
}